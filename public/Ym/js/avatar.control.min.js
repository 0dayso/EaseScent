
CFG=Duck.config;$(document).ready(function(){$(function(){$('#file_avatar_upload').uploadify({'uploader':'/Js/uploadify.swf','script':'/Include/uploadFace.php','buttonImg':CFG.TPL_PATH+'/images/button-avatar.gif','cancelImg':CFG.TPL_PATH+'/images/cancel.png','folder':'/Data/Uploads/Avatar/real','fileExt':'*.jpg;*.gif;*.png','fileDesc':'Image Files','auto':true,'removeCompleted':true,'sizeLimit':1*1024*1024,'onError':function(event,ID,fileObj,errorObj){errorMsg('100016');},'onComplete':function(event,queueId,fileObj,response,data){var resp=response.split('-');if(resp[0]=='1'){$("#uploaded-image").html('<img src="/Data/Uploads/Avatar/real/'+resp[1].replace(/(^\s*)|(\s*$)/g,'')+'"/>');$("#preview-image").html('<img id="preview" src="/Data/Uploads/Avatar/real/'+resp[1]+'"/>');$("#preview-image-s").html('<img id="preview-s" src="/Data/Uploads/Avatar/real/'+resp[1]+'"/>');$("#button-container").html('<a href="#" id="post-avatar" class="b-face-save">&nbsp;</a>');initJcrop();$("#image-filename").val(resp[1]);$("#o-image-width").val(resp[2]);$("#o-image-height").val(resp[3]);}else{alert('\u56fe\u7247\u4e0a\u4f20\u5931\u8d25');}},'onCancel':function(){$("#upload-file").val('');}});});});function initJcrop()
{$("#uploaded-image img").Jcrop({minSize:[40,40],maxSize:[600,600],aspectRatio:1,setSelect:[0,0,298,298],onChange:jcropChange,onSelect:jcropChange});}
function jcropChange(change)
{$("#image-x").val(change.x);$("#image-y").val(change.y);$("#image-width").val(change.w);$("#image-height").val(change.h);showPreview(change);}
function showPreview(coords)
{var imageWidth=$("#o-image-width").val();var imageHeight=$("#o-image-height").val();if(parseInt(coords.w)>0){var rx=180/coords.w;var ry=180/coords.h;$("#preview").css({width:Math.round(rx*imageWidth)+'px',height:Math.round(ry*imageHeight)+'px',marginLeft:'-'+Math.round(rx*coords.x)+'px',marginTop:'-'+Math.round(ry*coords.y)+'px'});var rx=50/coords.w;var ry=50/coords.h;$("#preview-s").css({width:Math.round(rx*imageWidth)+'px',height:Math.round(ry*imageHeight)+'px',marginLeft:'-'+Math.round(rx*coords.x)+'px',marginTop:'-'+Math.round(ry*coords.y)+'px'});}}
$("#post-avatar").live("click",function(){var x=$("#image-x").val();var y=$("#image-y").val();var width=$("#image-width").val();var height=$("#image-height").val();var filename=$("#image-filename").val()
$.post('/Api/Ajax/index.php',{m:'avatar',c:'crop',filename:filename,x:x,y:y,width:width,height:height},function(resp){if(resp.status=='1'){alert('\u5934\u50cf\u4fdd\u5b58\u6210\u529f\uff01');}else{errorMsg('\u5934\u50cf\u4fdd\u5b58\u5931\u8d25\uff01');return false;}
window.location.reload();},"json");});